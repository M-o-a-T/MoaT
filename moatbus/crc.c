#include "crc.h"
#include <stdio.h>

/*
 * These calls update a CRC with an n-bit wire state.
 *
 * MoaT uses 6- and 11-bit CRCs. 8-bit and 16-bit CRCs are also provided.
 *
 */

// tables generated by running "moatbus/crc.py"

static const u_int8_t table6[] = {
0, 11, 22, 29, 44, 39, 58, 49
};
static const u_int8_t table8[] = {
0, 39, 78, 105, 87, 112, 25, 62, 101, 66, 43, 12, 50, 21, 124, 91
};
static const u_int16_t table11[] = {
0, 822, 1644, 1370, 1595, 1293, 87, 865, 1685, 1443, 249, 975, 174, 920, 1730, 1524, 1993, 1279, 421, 659, 498, 708, 1950, 1192, 348, 618, 1840, 1030, 1895, 1105, 267, 573, 1393, 1607, 797, 43, 842, 124, 1318, 1552, 996, 210, 1416, 1726, 1503, 1769, 947, 133, 696, 398, 1236, 2018, 1155, 1973, 751, 473, 1069, 1819, 577, 375, 534, 288, 1146, 1868
};
static const u_int16_t table16[] = {
0, 13038, 26076, 22322, 31187, 19261, 7183, 12001, 16845, 29475, 9233, 5887, 14366, 2800, 24002, 28460, 12785, 799, 21549, 26307, 18466, 31436, 11774, 7952, 28732, 17106, 5600, 9998, 2543, 15105, 27699, 24285, 25570, 20748, 1598, 13520, 6705, 10463, 32749, 19715, 8751, 4289, 18419, 29981, 23548, 26898, 15904, 3278, 21011, 24829, 14287, 1313, 11200, 6446, 19996, 31986, 5086, 8496, 30210, 17644, 27149, 22755, 4049, 15679, 30127, 18241, 4211, 8861, 3196, 16018, 27040, 23374, 13410, 1676, 20926, 25424, 19889, 32607, 10349, 6787, 17502, 30384, 8578, 4972, 15757, 3939, 22609, 27327, 1427, 14205, 24655, 21153, 31808, 20142, 6556, 11122, 5709, 9379, 29585, 16767, 28574, 23920, 2626, 14508, 22400, 25966, 12892, 178, 11859, 7357, 19343, 31073, 10172, 5458, 16992, 28814, 24175, 27777, 15283, 2397, 26225, 21663, 941, 12611, 8098, 11596, 31358, 18576, 22837, 27611, 15593, 3591, 8422, 4616, 17722, 30676, 6392, 10774, 32036, 20426, 24875, 21445, 1271, 13849, 26820, 23082, 3352, 16374, 4375, 9209, 29899, 17957, 10505, 7143, 19669, 32315, 20698, 25140, 13574, 2024, 15063, 2105, 24331, 28133, 17156, 29162, 9944, 5174, 31514, 18932, 7878, 11304, 713, 12327, 26389, 22011, 2854, 14792, 28410, 23572, 29429, 16411, 5929, 9671, 19179, 30725, 12087, 7641, 13112, 470, 22244, 25610, 11418, 7796, 18758, 31656, 21833, 26535, 12437, 635, 27991, 24505, 2187, 14949, 5252, 9834, 29016, 17334, 7531, 12165, 30903, 19033, 25784, 22102, 356, 13194, 23718, 28232, 14714, 2964, 9589, 6043, 16553, 29255, 20344, 32150, 10916, 6218, 13995, 1093, 21367, 24985, 3765, 15451, 27497, 22919, 30566, 17800, 4794, 8276, 32393, 19559, 6997, 10683, 1882, 13748, 25222, 20584, 16196, 3498, 23192, 26742, 18071, 29817, 9035, 4517
};

// stupid macro time

#define CRC(POLY, BITS, D, TYPE)                                 \
u_int##TYPE##_t crc##BITS##_update(u_int##TYPE##_t crc, u_int8_t byte, u_int8_t n)     \
{                                                                \
    while(n >= D) {                                              \
        crc = table##BITS[(byte ^ crc) & ((1<<D)-1)] ^ (crc>>D); \
        n -= D;                                                  \
        byte >>= D;                                              \
    }                                                            \
    crc ^= byte;                                                 \
    while(n) {                                                   \
	crc = (crc & 1) ? ((crc >> 1) ^ POLY) : (crc >> 1);      \
        n--;                                                     \
    }                                                            \
    return crc;                                                  \
}                                                                \

//       /-polynomial (bitmask, reversed, implied +1 term)
//       |  /-degree of polynomial
//       |  | /-width of table
//       |  | |  /-data type (int8 or int16)
//CRC(  0x2C, 6,3, 8)
CRC(  0x97, 8,4, 8)
CRC( 0x64D,11,5,16)
CRC(0xAC9A,16,8,16)

u_int8_t crc6_update(u_int8_t crc, u_int8_t byte, u_int8_t n)
{
    while(n >= 3) {
        crc = table6[(byte ^ crc) & ((1<<3)-1)] ^ (crc>>3); \
        n -= 3;
        byte >>= 3;
    }

    crc ^= byte;
    while(n) {
	crc = (crc & 1) ? ((crc >> 1) ^ 0x2C) : (crc >> 1);
        n--;
    }
    return crc;
}

// NB: a n-bit table is not a prefix of an m-bit table.
//     This author learned that the hard way.
